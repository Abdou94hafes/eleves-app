<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Suivi des Ã©lÃ¨ves â€” FranÃ§ais</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0D1B2A; --panel:#101e2d; --card:#14273a; --muted:#1f3550;
    --accent:#00B4D8; --accent-2:#0096C7; --text:#E0E1DD; --sub:#A9BCD0;
    --good:#06d6a0; --warn:#ffd60a; --bad:#e63946;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    background: radial-gradient(800px 400px at 10% -10%, rgba(0,180,216,0.06), transparent), var(--bg);
    color:var(--text); -webkit-font-smoothing:antialiased;
  }
  header{ background:rgba(13,27,42,.85); border-bottom:1px solid rgba(255,255,255,.03); position:sticky; top:0; z-index:10; }
  .wrap{ max-width:1200px; margin:0 auto; padding:16px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
  h1{ margin:0; font-size:18px; display:flex; align-items:center; gap:10px }
  .badge{ background:var(--accent); color:#002733; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px }

  .container{ max-width:1200px; margin:20px auto; padding:0 16px; display:grid; grid-template-columns:1fr 1fr; gap:18px; }
  @media (max-width:980px){ .container{ grid-template-columns:1fr } }

  .card{ background:linear-gradient(180deg,var(--panel),var(--card)); border-radius:14px; padding:14px; border:1px solid rgba(255,255,255,.03); box-shadow:0 12px 30px rgba(0,0,0,.45); }
  .card h2{ margin:0 0 10px; color:var(--sub); font-size:15px }

  label{ display:block; color:#cfe8f6; font-weight:600; margin:8px 0 6px; font-size:13px }
  input[type="text"], input[type="number"], select, textarea {
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.06);
    background: linear-gradient(180deg,#0f2a3b,#0b2130); color:var(--text); outline:none;
  }
  input[type="number"]::-webkit-inner-spin-button{ opacity: .6 }
  textarea{ min-height:80px; resize:vertical; background:linear-gradient(180deg,#0f2d40,#0b2434) }

  .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
  .row-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px }
  @media (max-width:700px){ .row, .row-3{ grid-template-columns:1fr } }

  .btn{ background:var(--accent); color:#002733; padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:700; display:inline-flex; gap:8px; align-items:center; transition:transform .12s ease, box-shadow .12s; }
  .btn:hover{ transform:translateY(-3px); box-shadow:0 10px 30px rgba(0,180,216,.12) }
  .btn-ghost{ background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.06) }
  .btn-edit{ background:var(--warn); color:#000 }
  .btn-del{ background:var(--bad); color:#fff }
  .btn-pdf{ background:var(--accent); color:#002733 }

  .toolbar{ display:flex; gap:10px; margin-bottom:10px; align-items:center; flex-wrap:wrap }
  .toolbar input[type="search"]{ flex:1; min-width:180px }
  .list{ list-style:none; margin:0; padding:0; border-radius:10px; overflow:hidden; border:1px solid rgba(255,255,255,.03) }
  .list li{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.03); transition:background .14s }
  .list li:hover{ background:rgba(255,255,255,.02) }
  .left{ display:flex; align-items:center; gap:10px }
  .emoji{ font-size:20px; }
  .name{ font-weight:700; letter-spacing:.2px }

  .modal{ display:none; position:fixed; inset:0; z-index:999; background:rgba(1,8,16,.6); backdrop-filter: blur(6px); align-items:center; justify-content:center; padding:20px; }
  .modal.show{ display:flex; animation:modalFade .28s ease; }
  @keyframes modalFade{ from{opacity:0} to{opacity:1} }
  .modal-card{ background:#fff; color:#0b1b26; width:100%; max-width:760px; border-radius:12px; padding:18px; box-shadow:0 18px 50px rgba(2,16,28,.4); transform:translateY(12px); animation:modalUp .28s ease; }
  @keyframes modalUp{ from{ transform:translateY(16px); opacity:0 } to{ transform:none; opacity:1 } }
  .modal-header{ display:flex; justify-content:space-between; align-items:center; gap:10px }
  .close{ cursor:pointer; font-size:22px; color:#334455; background:transparent; border:none }

  .report-grid{ display:grid; grid-template-columns:1fr 360px; gap:14px }
  @media (max-width:880px){ .report-grid{ grid-template-columns:1fr } }
  table{ width:100%; border-collapse:collapse; margin-top:6px }
  table th, table td{ padding:8px 10px; border-bottom:1px solid #eef3f6; text-align:left; font-size:14px }
  table th{ background:#f5f8fb; color:#102334; font-weight:700 }

  .narrative{ margin-top:8px; padding:10px; background:#f7fafc; border-radius:8px; border:1px solid #e9eef3; color:#102334; line-height:1.45 }
  .progress-wrap{ margin-top:10px; background:#f0f4f7; border-radius:10px; overflow:hidden; border:1px solid #e6eef5 }
  .progress{ height:26px; width:0; background:linear-gradient(90deg,#06d6a0,#25d0ff); display:flex; align-items:center; justify-content:center; color:#002733; font-weight:700; transition:width .6s }

  .actions{ display:flex; gap:10px; margin-top:12px; justify-content:flex-end; flex-wrap:wrap }
  .loading{ opacity:.6; pointer-events:none }

  /* Toast */
  #toast{ position: fixed; bottom:18px; right:18px; background:#0f2a3b; color:#e6f7ff; padding:10px 12px; border:1px solid rgba(255,255,255,.08); border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.4); display:none; z-index:1000 }
</style>
</head>
<body>

<header>
  <div class="wrap">
    <h1><span style="font-size:18px">ðŸ“š</span> Suivi des Ã©lÃ¨ves â€” FranÃ§ais <span class="badge">Nuit</span></h1>
    <div style="font-size:13px; color:var(--sub)">Interface moderne â€¢ Imprimer rapports</div>
  </div>
</header>

<main class="container">
  <!-- Form -->
  <section class="card">
    <h2>Ajouter / Nouveau</h2>
    <div class="row">
      <div>
        <label>Nom</label>
        <input id="nom" type="text" placeholder="ex: Benali">
      </div>
      <div>
        <label>PrÃ©nom</label>
        <input id="prenom" type="text" placeholder="ex: Samir">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Sexe</label>
        <select id="sexe"><option value="H">Homme</option><option value="F">Femme</option></select>
      </div>
      <div>
        <label>Classe</label>
        <input id="classe" type="text" placeholder="ex: 2AM-B">
      </div>
    </div>

    <label>Notes du professeur</label>
    <textarea id="notes" placeholder="Observations, recommandations..."></textarea>

    <h2 style="margin-top:12px">CompÃ©tences (0â€“20)</h2>
    <div class="row-3">
      <div><label>Ã‰criture</label><input id="ecriture" type="number" min="0" max="20" value="0"></div>
      <div><label>Lecture</label><input id="lecture" type="number" min="0" max="20" value="0"></div>
      <div><label>Vocabulaire</label><input id="vocabulaire" type="number" min="0" max="20" value="0"></div>
      <div><label>Grammaire</label><input id="grammaire" type="number" min="0" max="20" value="0"></div>
      <div><label>Conjugaison</label><input id="conjugaison" type="number" min="0" max="20" value="0"></div>
      <div><label>Orthographe</label><input id="orthographe" type="number" min="0" max="20" value="0"></div>
    </div>

    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
      <button class="btn" id="btnAdd"><i class="fa-solid fa-user-plus"></i> Ajouter</button>
      <button class="btn btn-ghost" id="btnClear">Effacer</button>
      <small class="hint">Les donnÃ©es sont synchronisÃ©es avec Google Sheets</small>
    </div>
  </section>

  <!-- List -->
  <section class="card">
    <h2>Liste des Ã©lÃ¨ves</h2>
    <div class="toolbar" style="margin-bottom:12px">
      <input id="search" type="search" placeholder="Rechercher nom/prÃ©nom...">
      <select id="filterClasse"><option value="__all__">Toutes les classes</option></select>
      <select id="sortBy">
        <option value="name-asc">Nom Aâ†’Z</option>
        <option value="name-desc">Nom Zâ†’A</option>
        <option value="classe-asc">Classe Aâ†’Z</option>
        <option value="classe-desc">Classe Zâ†’A</option>
      </select>
      <button class="btn btn-ghost" id="btnReset">RÃ©initialiser</button>
      <button class="btn btn-ghost" id="btnRefresh" title="Actualiser"><i class="fa-solid fa-rotate"></i></button>
    </div>
    <ul id="list" class="list"></ul>
  </section>
</main>

<!-- Modal -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-header">
      <div>
        <div id="modalTitle" style="font-weight:800; font-size:16px">Rapport</div>
        <div style="font-size:13px; color:#445b6b" id="modalSub">â€”</div>
      </div>
      <div>
        <button class="btn btn-ghost" id="toggleEditBtn">Mode Ã©dition</button>
        <button class="close" id="btnCloseModal" title="Fermer">&times;</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="report-grid">
        <div id="reportLeft">
          <h3>Tableau des compÃ©tences</h3>
          <table id="skillsTable" aria-live="polite">
            <thead><tr><th>CompÃ©tence</th><th>Score /20</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="narrative" id="pedagoText">Texte pÃ©dagogique ...</div>
        </div>

        <div id="reportRight">
          <h3>Graphique</h3>
          <canvas id="studentChart" style="max-height:220px"></canvas>
          <div style="margin-top:10px">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <div style="font-size:13px; color:#445b6b">Progression globale</div>
              <div style="font-size:13px; color:#445b6b">Date: <span id="modalDate">â€”</span></div>
            </div>
            <div class="progress-wrap"><div id="modalProgress" class="progress">0%</div></div>
          </div>
          <div style="margin-top:12px">
            <div style="font-weight:700; margin-bottom:6px">Notes du professeur</div>
            <textarea id="modalNotes" style="width:100%; min-height:80px; background:linear-gradient(180deg,#072939,#0a2f43); color:#dff6ff; border-radius:8px; border:1px solid rgba(255,255,255,.06)"></textarea>
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-pdf" id="btnPrint"><i class="fa-solid fa-print"></i> Imprimer le rapport</button>
        <button id="saveEditBtn" class="btn btn-edit" style="display:none"><i class="fa-solid fa-floppy-disk"></i> Enregistrer</button>
        <button class="btn btn-ghost" id="btnCloseModal2">Fermer</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- Icons -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>

<script>
/* ================== Config ================== */
const API_BASE = 'https://script.google.com/macros/s/AKfycbywcuLXxYhGFEWhd0TiOD8s1FwGebxfGwf9DmfXZTFXPZeuDRs8mc8DjKXNJf4jxH73Uw/exec';
const MAX_SCORE = 20;

/* ================== State & utils ================== */
let students = [];
let activeIdx = null;
let chartInstance = null;
const skillsLabels = ["Ã‰criture","Lecture","Vocabulaire","Grammaire","Conjugaison","Orthographe"];

const qs = (id)=> document.getElementById(id);
const setLoading = (el,on)=>{ if(!el) return; el.classList.toggle('loading',!!on); el.disabled=!!on; };
const clamp = v => Math.max(0, Math.min(MAX_SCORE, Number(v)||0));
function toast(msg){ const t=qs('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(t._h); t._h=setTimeout(()=>t.style.display='none', 2400); }

/* ================== API via GET ================== */
async function getJSON(params){
  const url = API_BASE + '?' + new URLSearchParams(params).toString();
  const res = await fetch(url, { method: 'GET' });
  let data;
  try { data = await res.json(); }
  catch(e){
    const text = await res.text();
    console.error('Non-JSON response:', text.slice(0,200));
    throw new Error("Impossible de charger les donnÃ©es. VÃ©rifiez lien Web App et permissions d'accÃ¨s.");
  }
  return data;
}
const backend = {
  getAll(){           return getJSON({ action:'get' }); },
  create(s){          return getJSON({ action:'create', ...s }); },
  update(index, s){   return getJSON({ action:'update', index, ...s }); },
  remove(index){      return getJSON({ action:'delete', index }); }
};

/* ================== Form ================== */
function readFormValues(){
  return {
    nom: qs('nom').value.trim(),
    prenom: qs('prenom').value.trim(),
    sexe: qs('sexe').value,
    classe: qs('classe').value.trim(),
    notes: qs('notes').value.trim(),
    ecriture: clamp(qs('ecriture').value),
    lecture: clamp(qs('lecture').value),
    vocabulaire: clamp(qs('vocabulaire').value),
    grammaire: clamp(qs('grammaire').value),
    conjugaison: clamp(qs('conjugaison').value),
    orthographe: clamp(qs('orthographe').value),
    date: new Date().toLocaleDateString()
  };
}
async function addStudent(){
  const btn = qs('btnAdd'); setLoading(btn,true);
  try{
    const s = readFormValues();
    if(!s.nom || !s.prenom){ alert('Nom et prÃ©nom requis'); return; }
    const r = await backend.create(s);
    if(r && r.ok===false){ throw new Error(r.error||'create failed'); }
    await loadStudents();
    clearForm();
    toast('Ã‰lÃ¨ve ajoutÃ©.');
  } catch(e){ alert(e.message || "Erreur lors de l'ajout."); }
  finally{ setLoading(btn,false); }
}
function clearForm(){
  ['nom','prenom','classe','notes','ecriture','lecture','vocabulaire','grammaire','conjugaison','orthographe'].forEach(id=>qs(id).value='');
  qs('sexe').value='H';
}

/* ================== List / Filters / Sort ================== */
function uniqueClasses(){ const set = new Set(students.map(s=>s.classe).filter(Boolean)); return ['__all__', ...[...set].sort()]; }
function populateFilter(){
  const sel = qs('filterClasse'); const prev = sel.value;
  sel.innerHTML = uniqueClasses().map(c=>`<option value="${c}">${c==='__all__'?'Toutes les classes':c}</option>`).join('');
  sel.value = [...sel.options].some(o=>o.value===prev) ? prev : '__all__';
}
function resetFilters(){ qs('search').value=''; qs('filterClasse').value='__all__'; qs('sortBy').value='name-asc'; renderList(); }
function renderList(){
  populateFilter();
  const q = (qs('search').value||'').toLowerCase().trim();
  const classe = qs('filterClasse').value;
  const sortBy = qs('sortBy').value;
  let list = [...students];

  list = list.filter(s=>{
    const name = (s.nom+' '+s.prenom).toLowerCase();
    const okQ = !q || name.includes(q);
    const okC = classe==='__all__' || !classe || s.classe===classe;
    return okQ && okC;
  });

  if(sortBy==='name-asc') list.sort((a,b)=> (a.nom+' '+a.prenom).localeCompare(b.nom+' '+b.prenom));
  if(sortBy==='name-desc') list.sort((a,b)=> (b.nom+' '+b.prenom).localeCompare(a.nom+' '+a.prenom));
  if(sortBy==='classe-asc') list.sort((a,b)=> (a.classe||'').localeCompare(b.classe||''));
  if(sortBy==='classe-desc') list.sort((a,b)=> (b.classe||'').localeCompare(a.classe||''));

  const ul = qs('list'); ul.innerHTML='';
  list.forEach(s=>{
    const idx = students.indexOf(s);
    const li = document.createElement('li');
    li.innerHTML = `
      <div class="left">
        <div class="emoji">${s.sexe==='H'?'ðŸ‘¨':'ðŸ‘©'}</div>
        <div>
          <div class="name">${s.nom} ${s.prenom}</div>
          <div style="font-size:12px; color:var(--sub)">${s.classe||'â€”'}</div>
        </div>
      </div>
      <div style="display:flex; gap:8px">
        <button class="btn btn-ghost" title="Voir le rapport" onclick="openModal(${idx}, false)"><i class="fa-solid fa-file-lines"></i> Rapport</button>
        <button class="btn btn-edit" title="Modifier" onclick="openModal(${idx}, true)"><i class="fa-solid fa-pen-to-square"></i> Modifier</button>
        <button class="btn btn-del" title="Supprimer" onclick="deleteStudent(${idx})"><i class="fa-solid fa-trash"></i></button>
      </div>`;
    ul.appendChild(li);
  });
}

/* ================== Delete ================== */
async function deleteStudent(arrIndex){
  const s = students[arrIndex]; if(!s) return;
  if(!confirm('Supprimer cet Ã©lÃ¨ve ?')) return;
  try{
    const r = await backend.remove(s.index);
    if(r && r.ok===false){ throw new Error(r.error||'delete failed'); }
    await loadStudents();
    closeModal();
    toast('Ã‰lÃ¨ve supprimÃ©.');
  } catch(e){ alert('Suppression impossible.'); }
}

/* ================== Modal / Report ================== */
const modal = qs('modal');
function openModal(arrIndex, editMode){
  activeIdx = arrIndex;
  const s = students[arrIndex]; if(!s) return;

  qs('modalTitle').textContent = `${s.nom} ${s.prenom}`;
  qs('modalSub').textContent = s.classe ? `Classe: ${s.classe}` : 'â€”';
  qs('modalDate').textContent = s.date || 'â€”';

  const tbody = document.querySelector('#skillsTable tbody'); tbody.innerHTML = '';
  const arr = [s.ecriture,s.lecture,s.vocabulaire,s.grammaire,s.conjugaison,s.orthographe];
  skillsLabels.forEach((lab,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${lab}</td><td>${arr[i] ?? 0}</td>`; tbody.appendChild(tr); });

  qs('pedagoText').innerHTML = generatePedagoText(s);
  qs('modalNotes').value = s.notes || '';
  renderStudentChart(arr);

  const pct = Math.round((arr.reduce((a,b)=>a+(Number(b)||0),0) / (arr.length*MAX_SCORE)) * 100);
  const prog = qs('modalProgress'); prog.style.width = pct+'%'; prog.textContent = pct+'%';

  toggleEditMode(editMode);
  modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
}
function closeModal(){
  modal.classList.remove('show'); modal.setAttribute('aria-hidden','true');
  activeIdx = null;
  if(chartInstance){ chartInstance.destroy(); chartInstance = null; }
}
qs('btnCloseModal').addEventListener('click', closeModal);
qs('btnCloseModal2').addEventListener('click', closeModal);

function renderStudentChart(data){
  const ctx = qs('studentChart'); if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type:'bar',
    data:{ labels: skillsLabels, datasets:[{ label:'Score /20', data: data.map(v=>Number(v)||0), backgroundColor:'rgba(0,180,216,0.75)', borderColor:'#00B4D8', borderWidth:1, borderRadius:8 }] },
    options:{ animation:{ duration:700, easing:'easeOutQuart' }, scales:{ y:{ beginAtZero:true, max:MAX_SCORE, ticks:{ stepSize:2 } } }, plugins:{ legend:{ display:false } } }
  });
}

/* ================== Pedagogical ================== */
function generatePedagoText(s){
  const scores = [s.ecriture,s.lecture,s.vocabulaire,s.grammaire,s.conjugaison,s.orthographe].map(v=>Number(v)||0);
  const mean = Math.round((scores.reduce((a,b)=>a+b,0)/scores.length)*100)/100;
  const best = Math.max(...scores), worst = Math.min(...scores);
  const bestIdx = scores.indexOf(best), worstIdx = scores.indexOf(worst);
  let level; if(mean >= 15) level='maÃ®trise solide'; else if(mean >= 10) level='compÃ©tences en progression'; else level='besoin dâ€™un accompagnement ciblÃ©';
  return `<strong>Analyse pÃ©dagogique :</strong> L'Ã©lÃ¨ve prÃ©sente une <em>${level}</em> (moyenne ${mean}/20). Les compÃ©tences les plus abouties sont <strong>${skillsLabels[bestIdx]}</strong> (${best}/20), tandis que <strong>${skillsLabels[worstIdx]}</strong> (${worst}/20) nÃ©cessite(nt) une attention particuliÃ¨re. Pistes pÃ©dagogiques : renforcement par activitÃ©s diffÃ©renciÃ©es, exercices de remÃ©diation ciblÃ©e et Ã©valuation formative rÃ©guliÃ¨re.`;
}

/* ================== Edit mode ================== */
function toggleEditMode(enable){
  const notes = qs('modalNotes');
  const saveBtn = qs('saveEditBtn');
  const toggleBtn = qs('toggleEditBtn');

  if(enable){
    const tbody = document.querySelector('#skillsTable tbody');
    const s = students[activeIdx]; tbody.innerHTML='';
    const keys = ['ecriture','lecture','vocabulaire','grammaire','conjugaison','orthographe'];
    keys.forEach((k,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${skillsLabels[i]}</td><td><input type="number" min="0" max="${MAX_SCORE}" id="edit_${k}" value="${s[k] ?? 0}" style="width:100%; background:linear-gradient(180deg,#072939,#0a2f43); color:#dff6ff; border-radius:6px; border:1px solid rgba(255,255,255,.06); padding:6px"></td>`;
      tbody.appendChild(tr);
    });
    notes.style.display='block';
    saveBtn.style.display='inline-flex';
    toggleBtn.textContent='Annuler Ã©dition';
    toggleBtn.onclick = ()=>toggleEditMode(false);
  } else {
    const s = students[activeIdx]; if(!s) return;
    const tbody = document.querySelector('#skillsTable tbody'); tbody.innerHTML='';
    const arr = [s.ecriture,s.lecture,s.vocabulaire,s.grammaire,s.conjugaison,s.orthographe];
    arr.forEach((val,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${skillsLabels[i]}</td><td>${val ?? 0}</td>`; tbody.appendChild(tr); });
    qs('pedagoText').innerHTML = generatePedagoText(s);
    renderStudentChart(arr);
    qs('modalNotes').value = s.notes || '';
    saveBtn.style.display = 'none';
    toggleBtn.textContent='Mode Ã©dition';
    toggleBtn.onclick = ()=>toggleEditMode(true);
  }
}
async function saveEdit(){
  if(activeIdx === null) return;
  const s = students[activeIdx];
  ['ecriture','lecture','vocabulaire','grammaire','conjugaison','orthographe'].forEach(k=>{
    const el = qs('edit_'+k); if(el) s[k] = clamp(el.value);
  });
  s.notes = qs('modalNotes').value || '';
  s.date = new Date().toLocaleDateString();
  try{
    const r = await backend.update(s.index, s);
    if(r && r.ok===false){ throw new Error(r.error||'update failed'); }
    await loadStudents();
    toggleEditMode(false);
    renderList();
    qs('modalDate').textContent = s.date;
    toast('Modifications enregistrÃ©es.');
  }catch(err){ alert('Ã‰chec de la sauvegarde.'); }
}

/* ================== Print ================== */
function printReport(){
  if(!chartInstance) { alert("Le graphique n'est pas prÃªt."); return; }
  const s = students[activeIdx];
  const tableHtml = document.querySelector('#skillsTable').outerHTML;
  const pedago = qs('pedagoText').innerHTML;
  const notes = qs('modalNotes').value || '';
  const date = s.date || new Date().toLocaleDateString();
  const pct = qs('modalProgress').textContent || '0%';
  const chartImg = chartInstance.toBase64Image();

  const printable = `
    <html><head><meta charset="utf-8"/>
      <title>Rapport - ${s.nom} ${s.prenom}</title>
      <style>
        body{font-family:Arial,Helvetica,sans-serif;color:#111;margin:20px}
        h2{margin-bottom:4px}.meta{color:#333;margin-bottom:8px}
        table{border-collapse:collapse;width:100%;margin-top:10px}
        th,td{border:1px solid #ddd;padding:8px;text-align:left}
        th{background:#f2f6fa;font-weight:700}
        .narrative{background:#f7fafc;padding:10px;border-radius:6px;border:1px solid #e8eef3;margin-top:10px}
        .progress{height:20px;width:${pct};background:linear-gradient(90deg,#06d6a0,#25d0ff);color:#012;text-align:center;font-weight:700;border-radius:6px}
        .notes{margin-top:10px;border:1px dashed #ddd;padding:8px;background:#fff}
        .chart{margin-top:10px;text-align:center}
      </style>
    </head><body>
      <h2>Rapport pÃ©dagogique â€” ${s.nom} ${s.prenom}</h2>
      <div class="meta"><b>Classe:</b> ${s.classe||'â€”'} &nbsp; | &nbsp; <b>Date:</b> ${date} &nbsp; | &nbsp; <b>Niveau global:</b> ${pct}</div>
      ${tableHtml}
      <div class="chart"><img src="${chartImg}" style="max-width:100%;height:auto;border:1px solid #eee;border-radius:6px"></div>
      <div class="narrative">${pedago}</div>
      <div style="margin-top:10px"><b>Notes du professeur</b><div class="notes">${notes}</div></div>
      <div style="margin-top:18px;font-size:12px;color:#666">GÃ©nÃ©rÃ© depuis l'application Suivi des Ã©lÃ¨ves.</div>
    </body></html>`;
  const win = window.open('','_blank','noopener,noreferrer');
  win.document.open(); win.document.write(printable); win.document.close();
  win.onload = ()=>{ win.focus(); setTimeout(()=>{ win.print(); }, 400); };
}

/* ================== Load & Events ================== */
async function loadStudents(){
  const btn = qs('btnRefresh'); setLoading(btn, true);
  try{
    const data = await backend.getAll();
    students = Array.isArray(data) ? data.map((r,i)=>({
      index: r.index ?? i,
      nom: r.nom || r.Nom || '',
      prenom: r.prenom || r.Prenom || r['PrÃ©nom'] || '',
      sexe: r.sexe || r.Sexe || 'H',
      classe: r.classe || r.Classe || '',
      notes: r.notes || r.Notes || '',
      ecriture: Number(r.ecriture ?? r.Ecriture ?? 0),
      lecture: Number(r.lecture ?? r.Lecture ?? 0),
      vocabulaire: Number(r.vocabulaire ?? r.Vocabulaire ?? 0),
      grammaire: Number(r.grammaire ?? r.Grammaire ?? 0),
      conjugaison: Number(r.conjugaison ?? r.Conjugaison ?? 0),
      orthographe: Number(r.orthographe ?? r.Orthographe ?? 0),
      date: r.date || r.Date || new Date().toLocaleDateString()
    })) : [];
    renderList();
  }catch(err){
    alert("Impossible de charger les donnÃ©es. VÃ©rifiez Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¨ ÙˆØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„.");
  }finally{
    setLoading(btn, false);
  }
}

function attachEvents(){
  qs('btnAdd').addEventListener('click', addStudent);
  qs('btnClear').addEventListener('click', clearForm);
  qs('btnReset').addEventListener('click', resetFilters);
  qs('btnRefresh').addEventListener('click', loadStudents);
  qs('search').addEventListener('input', renderList);
  qs('filterClasse').addEventListener('change', renderList);
  qs('sortBy').addEventListener('change', renderList);
  qs('toggleEditBtn').addEventListener('click', ()=>toggleEditMode(true));
  qs('btnPrint').addEventListener('click', printReport);
  qs('btnCloseModal2').addEventListener('click', closeModal);
}

function init(){ attachEvents(); loadStudents(); }
init();
</script>

</body>
</html>
