<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Suivi des Ã©lÃ¨ves â€” Firebase</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Firebase compat SDK (app + firestore) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<!-- Font Awesome (icons) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
  :root{
    --bg:#0D1B2A; --panel:#101e2d; --card:#14273a; --muted:#1f3550; --accent:#00B4D8; --accent-2:#0096C7;
    --text:#E0E1DD; --sub:#A9BCD0; --good:#06d6a0; --warn:#ffd60a; --bad:#e63946;
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    background: radial-gradient(800px 400px at 10% -10%, rgba(0,180,216,0.06), transparent), var(--bg);
    color:var(--text); -webkit-font-smoothing:antialiased; }
  header{ background:rgba(13,27,42,.85); border-bottom:1px solid rgba(255,255,255,.03); position:sticky; top:0; z-index:10; }
  .wrap{ max-width:1200px; margin:0 auto; padding:16px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
  h1{ margin:0; font-size:18px; display:flex; align-items:center; gap:10px }
  .badge{ background:var(--accent); color:#002733; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px }

  .container{ max-width:1200px; margin:20px auto; padding:0 16px; display:grid; grid-template-columns:1fr 1fr; gap:18px; }
  @media (max-width:980px){ .container{ grid-template-columns:1fr } }

  .card{ background:linear-gradient(180deg,var(--panel),var(--card)); border-radius:14px; padding:14px; border:1px solid rgba(255,255,255,.03); box-shadow:0 12px 30px rgba(0,0,0,.45); }
  .card h2{ margin:0 0 10px; color:var(--sub); font-size:15px }

  label{ display:block; color:#cfe8f6; font-weight:600; margin:8px 0 6px; font-size:13px }
  input[type="text"], input[type="number"], select, textarea {
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.06);
    background: linear-gradient(180deg,#0f2a3b,#0b2130); color:var(--text); outline:none;
  }
  textarea{ min-height:80px; resize:vertical; background:linear-gradient(180deg,#0f2d40,#0b2434) }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
  .row-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px }
  @media (max-width:700px){ .row, .row-3{ grid-template-columns:1fr } }

  .btn{ background:var(--accent); color:#002733; padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:700; display:inline-flex; gap:8px; align-items:center; transition:transform .12s ease, box-shadow .12s; }
  .btn:hover{ transform:translateY(-3px); box-shadow:0 10px 30px rgba(0,180,216,.12) }
  .btn-ghost{ background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.06) }
  .btn-edit{ background:var(--warn); color:#000 }
  .btn-del{ background:var(--bad); color:#fff }
  .btn-pdf{ background:var(--accent); color:#002733 }

  .toolbar{ display:flex; gap:10px; margin-bottom:10px; align-items:center }
  .toolbar input[type="search"]{ flex:1 }
  .list{ list-style:none; margin:0; padding:0; border-radius:10px; overflow:hidden; border:1px solid rgba(255,255,255,.03) }
  .list li{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.03); transition:background .14s }
  .list li:hover{ background:rgba(255,255,255,.02) }
  .left{ display:flex; align-items:center; gap:10px }
  .emoji{ font-size:20px }
  .name{ font-weight:700; letter-spacing:.2px }
  .pill{ font-size:12px; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.04); color:var(--text) }

  .modal{ display:none; position:fixed; inset:0; z-index:999; background:rgba(1,8,16,.6); backdrop-filter: blur(6px); align-items:center; justify-content:center; padding:20px; }
  .modal.show{ display:flex; animation:modalFade .28s ease; }
  @keyframes modalFade{ from{opacity:0} to{opacity:1} }

  .modal-card{ background:#fff; color:#0b1b26; width:100%; max-width:760px; border-radius:12px; padding:18px; box-shadow:0 18px 50px rgba(2,16,28,.4); transform:translateY(12px); animation:modalUp .28s ease; }
  @keyframes modalUp{ from{ transform:translateY(16px); opacity:0 } to{ transform:none; opacity:1 } }

  .modal-header{ display:flex; justify-content:space-between; align-items:center; gap:10px }
  .close{ cursor:pointer; font-size:22px; color:#334455; background:transparent; border:none }

  .report-grid{ display:grid; grid-template-columns:1fr 360px; gap:14px }
  @media (max-width:880px){ .report-grid{ grid-template-columns:1fr } }
  table{ width:100%; border-collapse:collapse; margin-top:6px }
  table th, table td{ padding:8px 10px; border-bottom:1px solid #eef3f6; text-align:left; font-size:14px }
  table th{ background:#f5f8fb; color:#102334; font-weight:700 }

  .narrative{ margin-top:8px; padding:10px; background:#f7fafc; border-radius:8px; border:1px solid #e9eef3; color:#102334; line-height:1.45 }
  .progress-wrap{ margin-top:8px; background:#f0f4f7; border-radius:10px; overflow:hidden; border:1px solid #e6eef5 }
  .progress{ height:26px; width:0; background:linear-gradient(90deg,#06d6a0,#25d0ff); display:flex; align-items:center; justify-content:center; color:#002733; font-weight:700; transition:width .6s }

  .modal input[type="number"], .modal input[type="text"], .modal textarea, .modal select {
    background: linear-gradient(180deg,#072939,#0a2f43); color: #e6f7ff; border-radius:8px; border:1px solid rgba(255,255,255,.06); padding:8px 10px;
  }
  .modal label{ color:#d6f0fb; }
  .actions{ display:flex; gap:10px; margin-top:12px; justify-content:flex-end; flex-wrap:wrap }

  small.hint{ color:#9fbbd0 }
</style>
</head>
<body>

<header>
  <div class="wrap">
    <h1><span style="font-size:18px">ðŸ“š</span> Suivi des Ã©lÃ¨ves â€” FranÃ§ais <span class="badge">Nuit</span></h1>
    <div style="font-size:13px; color:var(--sub)">DonnÃ©es partagÃ©es via Firebase â€¢ Edition en temps rÃ©el</div>
  </div>
</header>

<main class="container">
  <!-- Form -->
  <section class="card">
    <h2>Ajouter / Nouveau</h2>
    <div class="row">
      <div><label>Nom</label><input id="nom" type="text" placeholder="ex: Benali"></div>
      <div><label>PrÃ©nom</label><input id="prenom" type="text" placeholder="ex: Samir"></div>
    </div>
    <div class="row">
      <div><label>Sexe</label><select id="sexe"><option value="H">Homme</option><option value="F">Femme</option></select></div>
      <div><label>Classe</label><input id="classe" type="text" placeholder="ex: 2AM-B"></div>
    </div>
    <label>Notes du professeur</label><textarea id="notes" placeholder="Observations, recommandations..."></textarea>

    <h2 style="margin-top:12px">CompÃ©tences (0â€“20)</h2>
    <div class="row-3">
      <div><label>Ã‰criture</label><input id="ecriture" type="number" min="0" max="20" value="0"></div>
      <div><label>Lecture</label><input id="lecture" type="number" min="0" max="20" value="0"></div>
      <div><label>Vocabulaire</label><input id="vocabulaire" type="number" min="0" max="20" value="0"></div>
      <div><label>Grammaire</label><input id="grammaire" type="number" min="0" max="20" value="0"></div>
      <div><label>Conjugaison</label><input id="conjugaison" type="number" min="0" max="20" value="0"></div>
      <div><label>Orthographe</label><input id="orthographe" type="number" min="0" max="20" value="0"></div>
    </div>

    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
      <button class="btn" onclick="onAdd()"> <i class="fa-solid fa-user-plus"></i> Ajouter</button>
      <button class="btn btn-ghost" onclick="clearForm()">Effacer</button>
      <small class="hint">Les donnÃ©es sont sauvegardÃ©es en ligne (Firestore)</small>
    </div>
  </section>

  <!-- List -->
  <section class="card">
    <h2>Liste des Ã©lÃ¨ves</h2>
    <div class="toolbar" style="margin-bottom:12px">
      <input id="search" type="search" placeholder="Rechercher nom/prÃ©nom..." oninput="renderList()">
      <select id="filterClasse" onchange="renderList()"><option value="__all__">Toutes les classes</option></select>
      <select id="sortBy" onchange="renderList()">
        <option value="name-asc">Nom Aâ†’Z</option>
        <option value="name-desc">Nom Zâ†’A</option>
        <option value="classe-asc">Classe Aâ†’Z</option>
        <option value="classe-desc">Classe Zâ†’A</option>
      </select>
      <button class="btn btn-ghost" onclick="resetFilters()">RÃ©initialiser</button>
    </div>

    <ul id="list" class="list"></ul>
  </section>
</main>

<!-- Modal -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-header">
      <div>
        <div id="modalTitle" style="font-weight:800; font-size:16px">Rapport</div>
        <div id="modalSub" style="font-size:13px;color:#445b6b">â€”</div>
      </div>
      <div>
        <button class="btn btn-ghost" id="toggleEditBtn" onclick="toggleEditMode(false)">Mode Ã©dition</button>
        <button class="close" onclick="closeModal()" title="Fermer">&times;</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="report-grid">
        <div id="reportLeft">
          <h3>Tableau des compÃ©tences</h3>
          <table id="skillsTable" aria-live="polite">
            <thead><tr><th>CompÃ©tence</th><th>Score /20</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="narrative" id="pedagoText">Texte pÃ©dagogique ...</div>
        </div>

        <div id="reportRight">
          <h3>Graphique</h3>
          <canvas id="studentChart" style="max-height:220px"></canvas>
          <div style="margin-top:10px">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <div style="font-size:13px; color:#445b6b">Progression globale</div>
              <div style="font-size:13px; color:#445b6b">Date: <span id="modalDate">â€”</span></div>
            </div>
            <div class="progress-wrap"><div id="modalProgress" class="progress">0%</div></div>
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:700; margin-bottom:6px">Notes du professeur</div>
            <textarea id="modalNotes" style="width:100%; min-height:80px; background:linear-gradient(180deg,#072939,#0a2f43); color:#dff6ff; border-radius:8px; border:1px solid rgba(255,255,255,.06)"></textarea>
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-pdf" onclick="printReport()"><i class="fa-solid fa-print"></i> Imprimer le rapport</button>
        <button id="saveEditBtn" class="btn btn-edit" onclick="saveEdit()" style="display:none"><i class="fa-solid fa-floppy-disk"></i> Enregistrer</button>
        <button class="btn btn-ghost" onclick="closeModal()">Fermer</button>
      </div>
    </div>
  </div>
</div>

<!-- script: Firebase config & app logic -->
<script>
  /***** 1) Ø¥Ø¹Ø¯Ø§Ø¯ Firebase (Ø§Ù„ØµÙ‚ config Ø§Ù„Ø°ÙŠ Ø£Ø¹Ø·ÙŠØªÙ†ÙŠ Ø¥ÙŠØ§Ù‡) *****/
  const firebaseConfig = {
    apiKey: "AIzaSyBX8Bs3sxY5XY_Yqeqvn9lWpF43gUHMPKI",
    authDomain: "monprojeteleve.firebaseapp.com",
    projectId: "monprojeteleve",
    storageBucket: "monprojeteleve.firebasestorage.app",
    messagingSenderId: "1097347950486",
    appId: "1:1097347950486:web:fbdde221bb2793928e9fb7",
    measurementId: "G-ZZL5PP7DBC"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /***** 2) Ø­Ø§Ù„Ø© Ù…Ø­Ù„ÙŠØ© ÙˆÙ…Ø±Ø¬Ø¹ Ø§Ù„Ø±Ø³Ù… *****/
  let students = [];          // ØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ù…Ù† firestore
  let activeIdx = null;       // index Ø¯Ø§Ø®Ù„ array students (Ø¨Ø¹Ø¯ Ù…Ù„Ø¦Ù‡Ø§)
  let activeDocId = null;     // id Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ÙÙŠ firestore
  let chartInstance = null;
  const skillsLabels = ["Ã‰criture","Lecture","Vocabulaire","Grammaire","Conjugaison","Orthographe"];

  /***** 3) Ø§Ø³ØªÙ…Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© students (Realtime) *****/
  function subscribeStudents(){
    db.collection('students').orderBy('createdAt','desc').onSnapshot(snapshot=>{
      const arr = [];
      snapshot.forEach(doc=>{
        const data = doc.data();
        data.id = doc.id;
        // createdAt Ù‚Ø¯ ÙŠÙƒÙˆÙ† null ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø› Ù†Ø­ÙˆÙ„Ù‡ Ù„Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
        data.date = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toLocaleDateString() : (data.date || '');
        arr.push(data);
      });
      students = arr;
      renderList();
    }, err => {
      console.error('Firestore onSnapshot error:', err);
      alert('Erreur de connexion Ã  Firestore. VÃ©rifiez la configuration.');
    });
  }

  // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙˆØ± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  subscribeStudents();

  /***** 4) ÙˆØ¸Ø§Ø¦Ù CRUD: add / update / delete *****/
  async function addStudentFirestore(obj){
    try{
      await db.collection('students').add({
        ...obj,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ ÙŠØ­Ø¯Ø« Ø§Ù„ØªØ­Ø¯ÙŠØ« UI ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    }catch(e){
      console.error(e); alert('Erreur lors de l\'ajout');
    }
  }

  async function deleteStudentFirestore(id){
    if(!confirm('Supprimer cet Ã©lÃ¨ve ?')) return;
    try{
      await db.collection('students').doc(id).delete();
      // UI Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© onSnapshot
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù…ÙØªÙˆØ­ Ù„Ø°Ù„Ùƒ Ø§Ù„Ø¹Ù†ØµØ± Ø£ØºÙ„Ù‚Ù‡
      if(activeDocId === id) closeModal();
    }catch(e){ console.error(e); alert('Erreur suppression'); }
  }

  async function updateStudentFirestore(id, updates){
    try{
      updates.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
      await db.collection('students').doc(id).update(updates);
    }catch(e){ console.error(e); alert('Erreur mise Ã  jour'); }
  }

  /***** 5) Ø±Ø¨Ø· Ø§Ù„ÙÙˆØ±Ù… Ù„Ù†Ø¯Ø§Ø¡ add *****/
  function onAdd(){
    const s = readFormValues();
    if(!s.nom || !s.prenom){ alert('Nom et prÃ©nom requis'); return; }
    addStudentFirestore(s);
    clearForm();
  }

  function readFormValues(){
    return {
      nom: document.getElementById('nom').value.trim(),
      prenom: document.getElementById('prenom').value.trim(),
      sexe: document.getElementById('sexe').value,
      classe: document.getElementById('classe').value.trim(),
      notes: document.getElementById('notes').value.trim(),
      ecriture: Number(document.getElementById('ecriture').value)||0,
      lecture: Number(document.getElementById('lecture').value)||0,
      vocabulaire: Number(document.getElementById('vocabulaire').value)||0,
      grammaire: Number(document.getElementById('grammaire').value)||0,
      conjugaison: Number(document.getElementById('conjugaison').value)||0,
      orthographe: Number(document.getElementById('orthographe').value)||0,
      date: new Date().toLocaleDateString()
    };
  }

  function clearForm(){
    ['nom','prenom','classe','notes','ecriture','lecture','vocabulaire','grammaire','conjugaison','orthographe'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('sexe').value='H';
  }

  /***** 6) ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (renderList) ÙˆÙÙ„ØªØ±/Ø¨Ø­Ø«/ØªØ±ØªÙŠØ¨ *****/
  function uniqueClasses(){
    const set = new Set(students.map(s=>s.classe).filter(Boolean));
    return ['__all__', ...[...set].sort()];
  }
  function populateFilter(){
    const sel = document.getElementById('filterClasse');
    sel.innerHTML = uniqueClasses().map(c=>`<option value="${c}">${c==='__all__'?'Toutes les classes':c}</option>`).join('');
    if(!sel.value) sel.value='__all__';
  }

  function renderList(){
    populateFilter();
    const q = (document.getElementById('search').value||'').toLowerCase().trim();
    const classe = document.getElementById('filterClasse').value;
    const sortBy = document.getElementById('sortBy').value;
    let list = [...students];

    // filter
    list = list.filter(s=>{
      const name = (s.nom+' '+s.prenom).toLowerCase();
      const okQ = !q || name.includes(q);
      const okC = classe==='__all__' || !classe || s.classe===classe;
      return okQ && okC;
    });

    // sort
    if(sortBy==='name-asc') list.sort((a,b)=> (a.nom+' '+a.prenom).localeCompare(b.nom+' '+b.prenom));
    if(sortBy==='name-desc') list.sort((a,b)=> (b.nom+' '+b.prenom).localeCompare(a.nom+' '+a.prenom));
    if(sortBy==='classe-asc') list.sort((a,b)=> (a.classe||'').localeCompare(b.classe||''));
    if(sortBy==='classe-desc') list.sort((a,b)=> (b.classe||'').localeCompare(a.classe||''));

    const ul = document.getElementById('list'); ul.innerHTML='';
    list.forEach(s=>{
      const li = document.createElement('li');
      li.innerHTML = `
        <div class="left">
          <div class="emoji">${s.sexe==='H'?'ðŸ‘¨':'ðŸ‘©'}</div>
          <div>
            <div class="name">${s.nom} ${s.prenom}</div>
            <div style="font-size:12px; color:var(--sub)">${s.classe||'â€”'}</div>
          </div>
        </div>
        <div style="display:flex; gap:8px">
          <button class="btn btn-ghost" title="Voir le rapport" onclick="openModal('${s.id}', false)"><i class="fa-solid fa-file-lines"></i> Rapport</button>
          <button class="btn btn-edit" title="Modifier" onclick="openModal('${s.id}', true)"><i class="fa-solid fa-pen-to-square"></i> Modifier</button>
          <button class="btn btn-del" title="Supprimer" onclick="deleteStudentFirestore('${s.id}')"><i class="fa-solid fa-trash"></i></button>
        </div>
      `;
      ul.appendChild(li);
    });
  }

  function resetFilters(){ document.getElementById('search').value=''; document.getElementById('filterClasse').value='__all__'; document.getElementById('sortBy').value='name-asc'; renderList(); }

  /***** 7) Modal: open / close / edit mode *****/
  const modal = document.getElementById('modal');

  function openModal(docId, editMode){
    activeDocId = docId;
    const s = students.find(x=>x.id===docId);
    if(!s) return;
    // header
    document.getElementById('modalTitle').textContent = `${s.nom} ${s.prenom}`;
    document.getElementById('modalSub').textContent = s.classe ? `Classe: ${s.classe}` : 'â€”';
    document.getElementById('modalDate').textContent = s.date || s.createdAt || 'â€”';

    // table
    const tbody = document.querySelector('#skillsTable tbody'); tbody.innerHTML = '';
    const arr = [s.ecriture,s.lecture,s.vocabulaire,s.grammaire,s.conjugaison,s.orthographe];
    skillsLabels.forEach((lab,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${lab}</td><td>${arr[i] ?? 0}</td>`;
      tbody.appendChild(tr);
    });

    // narrative
    document.getElementById('pedagoText').innerHTML = generatePedagoText(s);

    // notes
    document.getElementById('modalNotes').value = s.notes || '';

    // chart
    renderStudentChart(arr);

    // progress
    const pct = Math.round((arr.reduce((a,b)=>a+(Number(b)||0),0) / (arr.length*20))*100);
    const prog = document.getElementById('modalProgress'); prog.style.width = pct+'%'; prog.textContent = pct+'%';

    // edit mode
    toggleEditMode(editMode);

    // show modal
    modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
  }

  function closeModal(){
    modal.classList.remove('show'); modal.setAttribute('aria-hidden','true');
    activeDocId = null;
    if(chartInstance){ chartInstance.destroy(); chartInstance=null; }
  }

  function toggleEditMode(enable){
    const notes = document.getElementById('modalNotes');
    const saveBtn = document.getElementById('saveEditBtn');
    const toggleBtn = document.getElementById('toggleEditBtn');

    if(enable){
      // replace table cells with inputs
      const tbody = document.querySelector('#skillsTable tbody'); tbody.innerHTML = '';
      const s = students.find(x=>x.id===activeDocId);
      const keys = ['ecriture','lecture','vocabulaire','grammaire','conjugaison','orthographe'];
      keys.forEach((k,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${skillsLabels[i]}</td><td><input type="number" min="0" max="20" id="edit_${k}" value="${s[k] ?? 0}" style="width:100%; background:linear-gradient(180deg,#072939,#0a2f43); color:#dff6ff; border-radius:6px; border:1px solid rgba(255,255,255,.06); padding:6px"></td>`;
        tbody.appendChild(tr);
      });
      notes.style.display='block';
      saveBtn.style.display='inline-flex';
      toggleBtn.textContent='Annuler Ã©dition';
      toggleBtn.onclick = ()=>toggleEditMode(false);
    } else {
      // restore view
      const s = students.find(x=>x.id===activeDocId);
      const tbody = document.querySelector('#skillsTable tbody'); tbody.innerHTML = '';
      const arr = [s.ecriture,s.lecture,s.vocabulaire,s.grammaire,s.conjugaison,s.orthographe];
      arr.forEach((val,i)=>{
        const tr = document.createElement('tr'); tr.innerHTML = `<td>${skillsLabels[i]}</td><td>${val ?? 0}</td>`; tbody.appendChild(tr);
      });
      document.getElementById('pedagoText').innerHTML = generatePedagoText(s);
      renderStudentChart(arr);
      document.getElementById('modalNotes').value = s.notes || '';
      document.getElementById('saveEditBtn').style.display = 'none';
      toggleBtn.textContent='Mode Ã©dition';
      toggleBtn.onclick = ()=>toggleEditMode(true);
    }
  }

  function saveEdit(){
    if(!activeDocId) return;
    const s = students.find(x=>x.id===activeDocId);
    if(!s) return;
    const keys = ['ecriture','lecture','vocabulaire','grammaire','conjugaison','orthographe'];
    const updates = {};
    keys.forEach(k=>{
      const el = document.getElementById('edit_'+k);
      if(el) updates[k] = Number(el.value) || 0;
    });
    updates.notes = document.getElementById('modalNotes').value || '';
    updates.date = new Date().toLocaleDateString();
    updateStudentFirestore(activeDocId, updates);
    toggleEditMode(false);
  }

  /***** Chart render for student *****/
  function renderStudentChart(data){
    const ctx = document.getElementById('studentChart');
    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type:'bar',
      data:{ labels: skillsLabels, datasets:[{ label:'Score /20', data: data.map(v=>Number(v)||0), backgroundColor:'rgba(0,180,216,0.75)', borderColor:'#00B4D8', borderWidth:1, borderRadius:8 }] },
      options:{ animation:{ duration:700, easing:'easeOutQuart' }, scales:{ y:{ beginAtZero:true, max:20, ticks:{ stepSize:2 } } }, plugins:{ legend:{ display:false } } }
    });
  }

  /***** Pedagogical paragraph generator *****/
  function generatePedagoText(s){
    const scores = [s.ecriture,s.lecture,s.vocabulaire,s.grammaire,s.conjugaison,s.orthographe].map(v=>Number(v)||0);
    const mean = Math.round((scores.reduce((a,b)=>a+b,0)/scores.length)*100)/100;
    const best = Math.max(...scores), worst = Math.min(...scores);
    const bestIdx = scores.indexOf(best), worstIdx = scores.indexOf(worst);
    let level = mean>=15? 'maÃ®trise solide' : mean>=10? 'compÃ©tences en progression' : 'besoin dâ€™un accompagnement ciblÃ©';
    let text = `<strong>Analyse pÃ©dagogique :</strong> L'Ã©lÃ¨ve prÃ©sente une <em>${level}</em> (moyenne ${mean}/20). `;
    text += `Les compÃ©tences les plus abouties sont <strong>${skillsLabels[bestIdx]}</strong> (${best}/20), tandis que <strong>${skillsLabels[worstIdx]}</strong> (${worst}/20) nÃ©cessite(nt) une attention particuliÃ¨re. `;
    text += `Pistes pÃ©dagogiques : activitÃ©s diffÃ©renciÃ©es, exercices de remÃ©diation ciblÃ©e et Ã©valuation formative rÃ©guliÃ¨re.`;
    return text;
  }

  /***** Print: build printable html and embed chart as image *****/
  function printReport(){
    if(!chartInstance || !activeDocId){ alert('Veuillez ouvrir le rapport avant d\'imprimer.'); return; }
    const s = students.find(x=>x.id===activeDocId);
    if(!s) return;
    const tableHtml = document.querySelector('#skillsTable').outerHTML;
    const pedago = document.getElementById('pedagoText').innerHTML;
    const notes = document.getElementById('modalNotes').value || s.notes || '';
    const date = s.date || new Date().toLocaleDateString();
    const pct = document.getElementById('modalProgress').textContent || '0%';
    const chartImg = chartInstance.toBase64Image();
    const printable = `
      <html><head><meta charset="utf-8"/><title>Rapport - ${s.nom} ${s.prenom}</title>
      <style>body{font-family:Arial,Helvetica,sans-serif;color:#111;margin:20px}h2{margin-bottom:4px}
      table{border-collapse:collapse;width:100%;margin-top:10px}table th,table td{border:1px solid #ddd;padding:8px;text-align:left}
      table th{background:#f2f6fa;font-weight:700}.narrative{background:#f7fafc;padding:10px;border-radius:6px;border:1px solid #e8eef3;margin-top:10px}
      .progress{height:20px;width:${pct};background:linear-gradient(90deg,#06d6a0,#25d0ff);color:#012;text-align:center;font-weight:700;border-radius:6px}
      .notes{margin-top:10px;border:1px dashed #ddd;padding:8px;background:#fff}.chart{margin-top:10px;text-align:center}</style>
      </head><body>
      <h2>Rapport pÃ©dagogique â€” ${s.nom} ${s.prenom}</h2>
      <div><b>Classe:</b> ${s.classe || 'â€”'} &nbsp; | &nbsp; <b>Date:</b> ${date} &nbsp; | &nbsp; <b>Niveau global:</b> ${pct}</div>
      ${tableHtml}
      <div class="chart"><img src="${chartImg}" style="max-width:100%; height:auto; border:1px solid #eee; border-radius:6px"></div>
      <div class="narrative">${pedago}</div>
      <div style="margin-top:10px"><b>Notes du professeur</b><div class="notes">${notes}</div></div>
      <div style="margin-top:18px;font-size:12px;color:#666">GÃ©nÃ©rÃ© depuis Suivi des Ã©lÃ¨ves (Firebase).</div>
      </body></html>`;
    const win = window.open('','_blank','noopener,noreferrer');
    win.document.open(); win.document.write(printable); win.document.close();
    win.onload = ()=>{ win.focus(); setTimeout(()=>win.print(), 400); };
  }

  /***** Init render ***** */
  function init(){
    renderList();
  }
  init();

  // helper: renderList initially when students array updated by subscribeStudents via onSnapshot
</script>

</body>
</html>
